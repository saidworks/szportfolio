name: Security Scanning

on:
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Target environment for security scan'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
        - quick
        - full
        - baseline

env:
  STAGING_FRONTEND_URL: 'https://app-portfoliocms-frontend-staging.azurewebsites.net'
  STAGING_API_URL: 'https://app-portfoliocms-api-staging.azurewebsites.net'
  PRODUCTION_FRONTEND_URL: 'https://app-portfoliocms-frontend-prod.azurewebsites.net'
  PRODUCTION_API_URL: 'https://app-portfoliocms-api-prod.azurewebsites.net'

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      run: dotnet restore ./PortfolioCMS.sln

    # Snyk vulnerability scanning
    - name: Run Snyk to check for vulnerabilities
      uses: snyk/actions/dotnet@master
      if: ${{ secrets.SNYK_TOKEN != '' }}
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --file=./PortfolioCMS.sln
      continue-on-error: true

    - name: Upload Snyk results to GitHub Code Scanning
      uses: github/codeql-action/upload-sarif@v3
      if: ${{ secrets.SNYK_TOKEN != '' }}
      with:
        sarif_file: snyk.sarif
      continue-on-error: true

    # OWASP Dependency Check
    - name: OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'PortfolioCMS'
        path: '.'
        format: 'ALL'
        args: >
          --enableRetired
          --enableExperimental
          --failOnCVSS 7
          --suppression .github/dependency-check-suppressions.xml
      continue-on-error: true

    - name: Upload OWASP Dependency Check results
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: reports/

    - name: Dependency scanning not fully configured
      if: ${{ secrets.SNYK_TOKEN == '' }}
      run: |
        echo "‚ö†Ô∏è Snyk scanning skipped - SNYK_TOKEN not configured"
        echo ""
        echo "To enable Snyk scanning:"
        echo "1. Create a free account at https://snyk.io"
        echo "2. Get your API token from Account Settings"
        echo "3. Add SNYK_TOKEN to GitHub repository secrets"
        echo ""
        echo "OWASP Dependency Check is running without Snyk integration"
        echo "For comprehensive vulnerability scanning, configure both tools"

  static-code-analysis:
    name: Static Code Analysis Security
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore and build
      run: |
        dotnet restore ./PortfolioCMS.sln
        dotnet build ./PortfolioCMS.sln --configuration Release --no-restore

    # GitHub CodeQL Analysis
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: csharp
        queries: security-extended,security-and-quality

    - name: Autobuild
      uses: github/codeql-action/autobuild@v3

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:csharp"

    - name: Security analysis summary
      run: |
        echo "üîí Security-focused static analysis completed"
        echo ""
        echo "Analysis includes:"
        echo "- GitHub CodeQL security queries"
        echo "- Common vulnerability patterns (SQL injection, XSS, etc.)"
        echo "- Authentication and authorization issues"
        echo "- Cryptographic weaknesses"
        echo "- Code injection vulnerabilities"
        echo ""
        echo "Results are available in the Security tab > Code scanning alerts"

  owasp-zap-scan:
    name: OWASP ZAP Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set target URLs
      id: set-urls
      run: |
        if [ "${{ github.event.inputs.target_environment }}" == "production" ]; then
          echo "frontend_url=${{ env.PRODUCTION_FRONTEND_URL }}" >> $GITHUB_OUTPUT
          echo "api_url=${{ env.PRODUCTION_API_URL }}" >> $GITHUB_OUTPUT
        else
          echo "frontend_url=${{ env.STAGING_FRONTEND_URL }}" >> $GITHUB_OUTPUT
          echo "api_url=${{ env.STAGING_API_URL }}" >> $GITHUB_OUTPUT
        fi

    - name: OWASP ZAP Baseline Scan - Frontend
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: ${{ steps.set-urls.outputs.frontend_url }}
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a -j -l WARN'
        issue_title: 'OWASP ZAP Frontend Scan - ${{ github.event.inputs.target_environment || 'staging' }}'
        token: ${{ secrets.GITHUB_TOKEN }}
        fail_action: false
      continue-on-error: true

    - name: Upload ZAP Frontend Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-frontend-report-${{ github.event.inputs.target_environment || 'staging' }}
        path: |
          report_html.html
          report_json.json
          report_md.md

    - name: OWASP ZAP API Scan
      uses: zaproxy/action-api-scan@v0.7.0
      with:
        target: ${{ steps.set-urls.outputs.api_url }}/swagger/v1/swagger.json
        format: openapi
        cmd_options: '-a -j -l WARN'
        issue_title: 'OWASP ZAP API Scan - ${{ github.event.inputs.target_environment || 'staging' }}'
        token: ${{ secrets.GITHUB_TOKEN }}
        fail_action: false
      continue-on-error: true

    - name: Upload ZAP API Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-api-report-${{ github.event.inputs.target_environment || 'staging' }}
        path: |
          report_html.html
          report_json.json
          report_md.md

    - name: ZAP scan summary
      run: |
        echo "üï∑Ô∏è OWASP ZAP security scans completed"
        echo ""
        echo "Scans performed:"
        echo "- Frontend baseline scan: ${{ steps.set-urls.outputs.frontend_url }}"
        echo "- API scan: ${{ steps.set-urls.outputs.api_url }}"
        echo "- Scan type: ${{ github.event.inputs.scan_type || 'full' }}"
        echo ""
        echo "Reports are available as workflow artifacts"
        echo "Issues are automatically created for findings"

  container-security-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: false  # Disabled until Docker containers are implemented
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker images
      run: |
        echo "üê≥ Building Docker images for security scanning"
        echo "docker build -t portfoliocms-frontend:latest -f src/PortfolioCMS.Frontend/Dockerfile ."
        echo "docker build -t portfoliocms-api:latest -f src/PortfolioCMS.API/Dockerfile ."

    - name: Run Trivy container security scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'portfoliocms-frontend:latest'
        format: 'sarif'
        output: 'trivy-frontend-results.sarif'
        severity: 'CRITICAL,HIGH'
      continue-on-error: true

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-frontend-results.sarif'
        category: 'trivy-frontend'
      continue-on-error: true

    - name: Run Trivy API container scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'portfoliocms-api:latest'
        format: 'sarif'
        output: 'trivy-api-results.sarif'
        severity: 'CRITICAL,HIGH'
      continue-on-error: true

    - name: Upload Trivy API results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-api-results.sarif'
        category: 'trivy-api'
      continue-on-error: true

  ssl-tls-scan:
    name: SSL/TLS Configuration Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Set target URLs
      id: set-urls
      run: |
        if [ "${{ github.event.inputs.target_environment }}" == "production" ]; then
          echo "frontend_url=${{ env.PRODUCTION_FRONTEND_URL }}" >> $GITHUB_OUTPUT
          echo "api_url=${{ env.PRODUCTION_API_URL }}" >> $GITHUB_OUTPUT
        else
          echo "frontend_url=${{ env.STAGING_FRONTEND_URL }}" >> $GITHUB_OUTPUT
          echo "api_url=${{ env.STAGING_API_URL }}" >> $GITHUB_OUTPUT
        fi

    - name: Install testssl.sh
      run: |
        git clone --depth 1 https://github.com/drwetter/testssl.sh.git
        chmod +x testssl.sh/testssl.sh

    - name: SSL/TLS Configuration Check - Frontend
      run: |
        echo "üîê Testing SSL/TLS configuration for Frontend"
        ./testssl.sh/testssl.sh --jsonfile frontend-ssl-results.json --severity HIGH ${{ steps.set-urls.outputs.frontend_url }} || true

    - name: SSL/TLS Configuration Check - API
      run: |
        echo "üîê Testing SSL/TLS configuration for API"
        ./testssl.sh/testssl.sh --jsonfile api-ssl-results.json --severity HIGH ${{ steps.set-urls.outputs.api_url }} || true

    - name: Upload SSL/TLS results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ssl-tls-results-${{ github.event.inputs.target_environment || 'staging' }}
        path: |
          frontend-ssl-results.json
          api-ssl-results.json

    - name: SSL/TLS scan summary
      run: |
        echo "üîê SSL/TLS configuration checks completed"
        echo ""
        echo "Checked endpoints:"
        echo "- Frontend: ${{ steps.set-urls.outputs.frontend_url }}"
        echo "- API: ${{ steps.set-urls.outputs.api_url }}"
        echo ""
        echo "Results include:"
        echo "- TLS version support"
        echo "- Cipher suite configuration"
        echo "- Certificate validation"
        echo "- Protocol vulnerabilities"

  security-headers-check:
    name: Security Headers Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Set target URLs
      id: set-urls
      run: |
        if [ "${{ github.event.inputs.target_environment }}" == "production" ]; then
          echo "frontend_url=${{ env.PRODUCTION_FRONTEND_URL }}" >> $GITHUB_OUTPUT
          echo "api_url=${{ env.PRODUCTION_API_URL }}" >> $GITHUB_OUTPUT
        else
          echo "frontend_url=${{ env.STAGING_FRONTEND_URL }}" >> $GITHUB_OUTPUT
          echo "api_url=${{ env.STAGING_API_URL }}" >> $GITHUB_OUTPUT
        fi

    - name: Check security headers - Frontend
      run: |
        echo "üõ°Ô∏è Checking security headers for Frontend"
        curl -I -s ${{ steps.set-urls.outputs.frontend_url }} | tee frontend-headers.txt
        
        echo ""
        echo "Validating required security headers:"
        
        # Check for required headers
        if grep -qi "Content-Security-Policy" frontend-headers.txt; then
          echo "‚úÖ Content-Security-Policy: Present"
        else
          echo "‚ùå Content-Security-Policy: Missing"
        fi
        
        if grep -qi "X-Frame-Options" frontend-headers.txt; then
          echo "‚úÖ X-Frame-Options: Present"
        else
          echo "‚ùå X-Frame-Options: Missing"
        fi
        
        if grep -qi "X-Content-Type-Options" frontend-headers.txt; then
          echo "‚úÖ X-Content-Type-Options: Present"
        else
          echo "‚ùå X-Content-Type-Options: Missing"
        fi
        
        if grep -qi "Strict-Transport-Security" frontend-headers.txt; then
          echo "‚úÖ Strict-Transport-Security: Present"
        else
          echo "‚ùå Strict-Transport-Security: Missing"
        fi
        
        if grep -qi "Referrer-Policy" frontend-headers.txt; then
          echo "‚úÖ Referrer-Policy: Present"
        else
          echo "‚ùå Referrer-Policy: Missing"
        fi

    - name: Check security headers - API
      run: |
        echo "üõ°Ô∏è Checking security headers for API"
        curl -I -s ${{ steps.set-urls.outputs.api_url }}/health | tee api-headers.txt
        
        echo ""
        echo "Validating required security headers:"
        
        # Check for required headers
        if grep -qi "Content-Security-Policy" api-headers.txt; then
          echo "‚úÖ Content-Security-Policy: Present"
        else
          echo "‚ùå Content-Security-Policy: Missing"
        fi
        
        if grep -qi "X-Frame-Options" api-headers.txt; then
          echo "‚úÖ X-Frame-Options: Present"
        else
          echo "‚ùå X-Frame-Options: Missing"
        fi
        
        if grep -qi "X-Content-Type-Options" api-headers.txt; then
          echo "‚úÖ X-Content-Type-Options: Present"
        else
          echo "‚ùå X-Content-Type-Options: Missing"
        fi

    - name: Upload security headers results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-headers-${{ github.event.inputs.target_environment || 'staging' }}
        path: |
          frontend-headers.txt
          api-headers.txt

  generate-security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, static-code-analysis, owasp-zap-scan, ssl-tls-scan, security-headers-check]
    if: always()
    
    steps:
    - name: Collect security scan results
      run: |
        echo "üìä Collecting security scan results"
        echo "Dependency Scan: ${{ needs.dependency-scan.result }}"
        echo "Static Code Analysis: ${{ needs.static-code-analysis.result }}"
        echo "OWASP ZAP Scan: ${{ needs.owasp-zap-scan.result }}"
        echo "SSL/TLS Scan: ${{ needs.ssl-tls-scan.result }}"
        echo "Security Headers Check: ${{ needs.security-headers-check.result }}"

    - name: Generate security report (Placeholder)
      run: |
        echo "üìã Generating comprehensive security report"
        echo "Report would include:"
        echo "- Executive summary"
        echo "- Vulnerability findings by severity"
        echo "- Remediation recommendations"
        echo "- Compliance status"
        echo "- Trend analysis"

    - name: Upload security report (Placeholder)
      run: |
        echo "üì§ Uploading security report"
        echo "Report would be uploaded to:"
        echo "- GitHub Security tab"
        echo "- Azure Security Center"
        echo "- Internal security dashboard"

# Configuration Instructions:
# 1. Configure secrets for security scanning tools:
#    - SNYK_TOKEN (if using Snyk)
#    - Other tool-specific tokens
# 2. Set up ZAP configuration files in .zap/ directory
# 3. Configure notification channels for security alerts
# 4. Set up security baseline and thresholds
# 5. Integrate with security incident response procedures