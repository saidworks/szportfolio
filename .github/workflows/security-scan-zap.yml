name: OWASP ZAP Security Scan

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: true
        default: 'https://your-app.azurewebsites.net'
      scan_type:
        description: 'Type of scan to perform'
        required: true
        default: 'baseline'
        type: choice
        options:
          - baseline
          - full

env:
  ZAP_VERSION: 'stable'

jobs:
  zap-baseline-scan:
    name: OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'baseline' || github.event_name == 'schedule' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: ${{ github.event.inputs.target_url || 'https://your-app.azurewebsites.net' }}
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a -j -l WARN'
        issue_title: 'OWASP ZAP Baseline Scan Report'
        token: ${{ secrets.GITHUB_TOKEN }}
        fail_action: false

    - name: Upload ZAP Baseline Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-baseline-report
        path: |
          report_html.html
          report_json.json
          report_md.md

  zap-full-scan:
    name: OWASP ZAP Full Scan
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'full' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: ZAP Full Scan
      uses: zaproxy/action-full-scan@v0.10.0
      with:
        target: ${{ github.event.inputs.target_url }}
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a -j -l WARN'
        issue_title: 'OWASP ZAP Full Scan Report'
        token: ${{ secrets.GITHUB_TOKEN }}
        fail_action: false

    - name: Upload ZAP Full Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-full-report
        path: |
          report_html.html
          report_json.json
          report_md.md

  zap-api-scan:
    name: OWASP ZAP API Scan
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'baseline' || github.event_name == 'schedule' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: ZAP API Scan
      uses: zaproxy/action-api-scan@v0.7.0
      with:
        target: ${{ github.event.inputs.target_url || 'https://your-api.azurewebsites.net' }}/swagger/v1/swagger.json
        format: openapi
        cmd_options: '-a -j -l WARN'
        issue_title: 'OWASP ZAP API Scan Report'
        token: ${{ secrets.GITHUB_TOKEN }}
        fail_action: false

    - name: Upload ZAP API Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-api-report
        path: |
          report_html.html
          report_json.json
          report_md.md

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [zap-baseline-scan, zap-api-scan]
    if: always()
    
    steps:
    - name: Notify on completion
      run: |
        echo "ðŸ”’ OWASP ZAP Security Scan completed"
        echo "Baseline Scan: ${{ needs.zap-baseline-scan.result }}"
        echo "API Scan: ${{ needs.zap-api-scan.result }}"
        echo "Check the artifacts for detailed reports"
