name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if CI checks fail'
        required: false
        default: false
        type: boolean

env:
  DOTNET_VERSION: '9.0.x'
  AZURE_RESOURCE_GROUP: 'rg-portfoliocms-staging'
  REGISTRY_NAME: 'acrportfoliocms'
  CONTAINER_APP_ENV: 'cae-portfoliocms-staging'
  API_CONTAINER_APP: 'ca-portfoliocms-api-staging'
  FRONTEND_CONTAINER_APP: 'ca-portfoliocms-frontend-staging'
  IMAGE_TAG: ${{ github.sha }}

jobs:
  verify-docker-images:
    name: Verify Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_NAME }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Verify API image exists
      run: |
        docker pull ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-api:${{ env.IMAGE_TAG }}
        echo "‚úÖ API image verified"

    - name: Verify Frontend image exists
      run: |
        docker pull ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-frontend:${{ env.IMAGE_TAG }}
        echo "‚úÖ Frontend image verified"

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: verify-docker-images
    if: success() || github.event.inputs.force_deploy == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Terraform Init
      run: terraform init
      working-directory: ./infrastructure
      env:
        ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
        ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

    - name: Terraform Plan
      run: terraform plan -var-file='environments/staging/terraform.tfvars' -out=tfplan
      working-directory: ./infrastructure
      env:
        ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
        ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        TF_VAR_sql_admin_password: ${{ secrets.SQL_ADMIN_PASSWORD }}

    - name: Terraform Apply
      run: terraform apply -auto-approve tfplan
      working-directory: ./infrastructure
      env:
        ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
        ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

  deploy-to-container-apps:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    
    steps:
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy API Container App
      uses: azure/container-apps-deploy-action@v1
      with:
        resourceGroup: ${{ env.AZURE_RESOURCE_GROUP }}
        containerAppName: ${{ env.API_CONTAINER_APP }}
        containerAppEnvironment: ${{ env.CONTAINER_APP_ENV }}
        imageToDeploy: ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-api:${{ env.IMAGE_TAG }}
        targetPort: 8080
        ingress: internal
        environmentVariables: |
          ASPNETCORE_ENVIRONMENT=Staging
          APPLICATIONINSIGHTS_CONNECTION_STRING=secretref:appinsights-connection-string
          KeyVault__VaultUri=secretref:keyvault-uri

    - name: Deploy Frontend Container App
      uses: azure/container-apps-deploy-action@v1
      with:
        resourceGroup: ${{ env.AZURE_RESOURCE_GROUP }}
        containerAppName: ${{ env.FRONTEND_CONTAINER_APP }}
        containerAppEnvironment: ${{ env.CONTAINER_APP_ENV }}
        imageToDeploy: ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-frontend:${{ env.IMAGE_TAG }}
        targetPort: 8080
        ingress: external
        environmentVariables: |
          ASPNETCORE_ENVIRONMENT=Staging
          services__api__http__0=http://${{ env.API_CONTAINER_APP }}



  run-database-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: deploy-to-container-apps
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install EF Core tools
      run: dotnet tool install --global dotnet-ef

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get SQL connection string from Key Vault
      id: get-connection-string
      run: |
        CONNECTION_STRING=$(az keyvault secret show --vault-name kv-portfoliocms-staging --name SqlConnectionString --query value -o tsv)
        echo "::add-mask::$CONNECTION_STRING"
        echo "connection_string=$CONNECTION_STRING" >> $GITHUB_OUTPUT

    - name: Run database migrations
      run: |
        dotnet ef database update --project src/PortfolioCMS.DataAccess --startup-project src/PortfolioCMS.API --connection "${{ steps.get-connection-string.outputs.connection_string }}"
      env:
        ASPNETCORE_ENVIRONMENT: Staging

  post-deployment-tests:
    name: Post-deployment Tests
    runs-on: ubuntu-latest
    needs: run-database-migrations
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get Container App URLs
      id: get-urls
      run: |
        FRONTEND_URL=$(az containerapp show --name ${{ env.FRONTEND_CONTAINER_APP }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)
        echo "frontend_url=https://$FRONTEND_URL" >> $GITHUB_OUTPUT
        echo "Frontend URL: https://$FRONTEND_URL"

    - name: Wait for applications to be ready
      run: |
        echo "‚è≥ Waiting for applications to be ready..."
        sleep 30

    - name: Health check - Frontend
      run: |
        curl -f ${{ steps.get-urls.outputs.frontend_url }}/health || exit 1
        echo "‚úÖ Frontend health check passed"

    - name: Run smoke tests
      run: |
        echo "üß™ Running smoke tests..."
        curl -f ${{ steps.get-urls.outputs.frontend_url }} || exit 1
        echo "‚úÖ Smoke tests passed"

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-to-container-apps, run-database-migrations, post-deployment-tests]
    if: always()
    
    steps:
    - name: Azure Login
      if: success()
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get deployment URLs
      if: success()
      id: get-urls
      run: |
        FRONTEND_URL=$(az containerapp show --name ${{ env.FRONTEND_CONTAINER_APP }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)
        echo "frontend_url=https://$FRONTEND_URL" >> $GITHUB_OUTPUT

    - name: Notify success
      if: ${{ needs.deploy-infrastructure.result == 'success' && needs.deploy-to-container-apps.result == 'success' && needs.run-database-migrations.result == 'success' && needs.post-deployment-tests.result == 'success' }}
      run: |
        echo "‚úÖ Staging deployment successful!"
        echo "Frontend URL: ${{ steps.get-urls.outputs.frontend_url }}"
        echo "Container Apps Environment: ${{ env.CONTAINER_APP_ENV }}"
        echo "Image Tag: ${{ env.IMAGE_TAG }}"
        echo "Ready for production deployment approval"

    - name: Notify failure
      if: ${{ needs.deploy-infrastructure.result == 'failure' || needs.deploy-to-container-apps.result == 'failure' || needs.run-database-migrations.result == 'failure' || needs.post-deployment-tests.result == 'failure' }}
      run: |
        echo "‚ùå Staging deployment failed!"
        echo "Infrastructure: ${{ needs.deploy-infrastructure.result }}"
        echo "Container Apps: ${{ needs.deploy-to-container-apps.result }}"
        echo "Database Migrations: ${{ needs.run-database-migrations.result }}"
        echo "Post-deployment Tests: ${{ needs.post-deployment-tests.result }}"
        exit 1