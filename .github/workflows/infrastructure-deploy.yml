name: Deploy Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/**'
  pull_request:
    branches:
      - main
    paths:
      - 'infrastructure/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - development
          - staging
          - production

env:
  TERRAFORM_VERSION: '1.6.0'
  WORKING_DIRECTORY: './infrastructure'

jobs:
  validate:
    name: Validate Terraform Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: terraform fmt -check -recursive

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: terraform validate

  plan-dev:
    name: Plan Development Environment
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'development')
    environment: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Retrieve SQL Password from Key Vault
        id: get-sql-password
        run: |
          SQL_PASSWORD=$(az keyvault secret show \
            --vault-name "kv-portfoliocms-dev" \
            --name "SqlAdminPassword" \
            --query "value" \
            --output tsv)
          echo "::add-mask::$SQL_PASSWORD"
          echo "sql_password=$SQL_PASSWORD" >> $GITHUB_OUTPUT

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: terraform init

      - name: Terraform Plan
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          TF_VAR_sql_admin_password: ${{ steps.get-sql-password.outputs.sql_password }}
        run: |
          terraform plan \
            -var-file="environments/development/terraform.tfvars" \
            -out=tfplan-dev

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v3
        with:
          name: tfplan-dev
          path: ${{ env.WORKING_DIRECTORY }}/tfplan-dev
          retention-days: 5

  plan-staging:
    name: Plan Staging Environment
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Retrieve SQL Password from Key Vault
        id: get-sql-password
        run: |
          SQL_PASSWORD=$(az keyvault secret show \
            --vault-name "kv-portfoliocms-staging" \
            --name "SqlAdminPassword" \
            --query "value" \
            --output tsv)
          echo "::add-mask::$SQL_PASSWORD"
          echo "sql_password=$SQL_PASSWORD" >> $GITHUB_OUTPUT

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: terraform init

      - name: Terraform Plan
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          TF_VAR_sql_admin_password: ${{ steps.get-sql-password.outputs.sql_password }}
        run: |
          terraform plan \
            -var-file="environments/staging/terraform.tfvars" \
            -out=tfplan-staging

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v3
        with:
          name: tfplan-staging
          path: ${{ env.WORKING_DIRECTORY }}/tfplan-staging
          retention-days: 5

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: plan-dev
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'development'
    environment: 
      name: development
      url: https://app-portfoliocms-frontend-dev.azurewebsites.net
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Retrieve SQL Password from Key Vault
        id: get-sql-password
        run: |
          SQL_PASSWORD=$(az keyvault secret show \
            --vault-name "kv-portfoliocms-dev" \
            --name "SqlAdminPassword" \
            --query "value" \
            --output tsv)
          echo "::add-mask::$SQL_PASSWORD"
          echo "sql_password=$SQL_PASSWORD" >> $GITHUB_OUTPUT

      - name: Download Plan Artifact
        uses: actions/download-artifact@v3
        with:
          name: tfplan-dev
          path: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: terraform init

      - name: Terraform Apply
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          TF_VAR_sql_admin_password: ${{ steps.get-sql-password.outputs.sql_password }}
        run: terraform apply -auto-approve tfplan-dev

      - name: Output Infrastructure Details
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "### Deployment Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq -r 'to_entries[] | "- **\(.key)**: \(.value.value)"' >> $GITHUB_STEP_SUMMARY

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: plan-staging
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: 
      name: staging
      url: https://app-portfoliocms-frontend-staging.azurewebsites.net
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Retrieve SQL Password from Key Vault
        id: get-sql-password
        run: |
          SQL_PASSWORD=$(az keyvault secret show \
            --vault-name "kv-portfoliocms-staging" \
            --name "SqlAdminPassword" \
            --query "value" \
            --output tsv)
          echo "::add-mask::$SQL_PASSWORD"
          echo "sql_password=$SQL_PASSWORD" >> $GITHUB_OUTPUT

      - name: Download Plan Artifact
        uses: actions/download-artifact@v3
        with:
          name: tfplan-staging
          path: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: terraform init

      - name: Terraform Apply
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          TF_VAR_sql_admin_password: ${{ steps.get-sql-password.outputs.sql_password }}
        run: terraform apply -auto-approve tfplan-staging

      - name: Output Infrastructure Details
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "### Deployment Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq -r 'to_entries[] | "- **\(.key)**: \(.value.value)"' >> $GITHUB_STEP_SUMMARY

  plan-production:
    name: Plan Production Environment
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production-plan
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Retrieve SQL Password from Key Vault
        id: get-sql-password
        run: |
          SQL_PASSWORD=$(az keyvault secret show \
            --vault-name "kv-portfoliocms-prod" \
            --name "SqlAdminPassword" \
            --query "value" \
            --output tsv)
          echo "::add-mask::$SQL_PASSWORD"
          echo "sql_password=$SQL_PASSWORD" >> $GITHUB_OUTPUT

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: terraform init

      - name: Terraform Plan
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          TF_VAR_sql_admin_password: ${{ steps.get-sql-password.outputs.sql_password }}
        run: |
          terraform plan \
            -var-file="environments/production/terraform.tfvars" \
            -out=tfplan-production

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v3
        with:
          name: tfplan-production
          path: ${{ env.WORKING_DIRECTORY }}/tfplan-production
          retention-days: 30

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: plan-production
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment: 
      name: production
      url: https://app-portfoliocms-frontend-prod.azurewebsites.net
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Retrieve SQL Password from Key Vault
        id: get-sql-password
        run: |
          SQL_PASSWORD=$(az keyvault secret show \
            --vault-name "kv-portfoliocms-prod" \
            --name "SqlAdminPassword" \
            --query "value" \
            --output tsv)
          echo "::add-mask::$SQL_PASSWORD"
          echo "sql_password=$SQL_PASSWORD" >> $GITHUB_OUTPUT

      - name: Download Plan Artifact
        uses: actions/download-artifact@v3
        with:
          name: tfplan-production
          path: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: terraform init

      - name: Terraform Apply
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          TF_VAR_sql_admin_password: ${{ steps.get-sql-password.outputs.sql_password }}
        run: terraform apply -auto-approve tfplan-production

      - name: Output Infrastructure Details
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "### Deployment Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq -r 'to_entries[] | "- **\(.key)**: \(.value.value)"' >> $GITHUB_STEP_SUMMARY

      - name: Create Deployment Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "production-$(date +%Y%m%d-%H%M%S)" -m "Production deployment"
          git push origin --tags
