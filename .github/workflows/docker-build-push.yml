name: Build and Push Docker Images

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'PortfolioCMS.sln'
      - '.github/workflows/docker-build-push.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'PortfolioCMS.sln'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  DOTNET_VERSION: '9.0.x'
  REGISTRY_NAME: 'acrportfoliocms'  # Update with your ACR name
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-test:
    name: Build and Test Solution
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore PortfolioCMS.sln

    - name: Build solution
      run: dotnet build PortfolioCMS.sln --configuration Release --no-restore

    - name: Run tests
      run: dotnet test PortfolioCMS.sln --configuration Release --no-build --verbosity normal --logger trx

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: '**/TestResults/*.trx'
        retention-days: 30

  build-api-image:
    name: Build API Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_NAME }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Extract metadata for API
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-api
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}

    - name: Build and push API image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./src/PortfolioCMS.API/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-api:${{ env.IMAGE_TAG }}
          ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-api:latest
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=registry,ref=${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-api:buildcache
        cache-to: type=registry,ref=${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-api:buildcache,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: Scan API image for vulnerabilities
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-api:${{ env.IMAGE_TAG }}
        format: 'sarif'
        output: 'trivy-api-results.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-api-results.sarif'
        category: 'api-container-scan'

  build-frontend-image:
    name: Build Frontend Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_NAME }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Extract metadata for Frontend
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-frontend
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}

    - name: Build and push Frontend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./src/PortfolioCMS.Frontend/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-frontend:${{ env.IMAGE_TAG }}
          ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-frontend:latest
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=registry,ref=${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-frontend:buildcache
        cache-to: type=registry,ref=${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-frontend:buildcache,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: Scan Frontend image for vulnerabilities
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-frontend:${{ env.IMAGE_TAG }}
        format: 'sarif'
        output: 'trivy-frontend-results.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-frontend-results.sarif'
        category: 'frontend-container-scan'

  create-deployment-manifest:
    name: Create Deployment Manifest
    runs-on: ubuntu-latest
    needs: [build-api-image, build-frontend-image]
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create deployment manifest
      run: |
        cat > deployment-manifest.json << EOF
        {
          "version": "1.0",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "images": {
            "api": {
              "repository": "${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-api",
              "tag": "${{ env.IMAGE_TAG }}"
            },
            "frontend": {
              "repository": "${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-frontend",
              "tag": "${{ env.IMAGE_TAG }}"
            }
          },
          "environment": "${{ github.event.inputs.environment || 'staging' }}"
        }
        EOF

    - name: Upload deployment manifest
      uses: actions/upload-artifact@v4
      with:
        name: deployment-manifest
        path: deployment-manifest.json
        retention-days: 90

  notify-build-status:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-api-image, build-frontend-image, create-deployment-manifest]
    if: always()
    
    steps:
    - name: Build success notification
      if: ${{ needs.build-api-image.result == 'success' && needs.build-frontend-image.result == 'success' }}
      run: |
        echo "✅ Docker images built and pushed successfully!"
        echo "API Image: ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-api:${{ env.IMAGE_TAG }}"
        echo "Frontend Image: ${{ env.REGISTRY_NAME }}.azurecr.io/portfoliocms-frontend:${{ env.IMAGE_TAG }}"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"

    - name: Build failure notification
      if: ${{ needs.build-api-image.result == 'failure' || needs.build-frontend-image.result == 'failure' }}
      run: |
        echo "❌ Docker image build failed!"
        echo "API Build: ${{ needs.build-api-image.result }}"
        echo "Frontend Build: ${{ needs.build-frontend-image.result }}"
        exit 1
