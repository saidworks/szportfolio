{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "dashboardName": {
      "type": "string",
      "defaultValue": "PortfolioCMS-Production-Dashboard",
      "metadata": {
        "description": "Name of the dashboard"
      }
    },
    "applicationInsightsName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Application Insights resource"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for the dashboard"
      }
    }
  },
  "variables": {
    "applicationInsightsId": "[resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Portal/dashboards",
      "apiVersion": "2020-09-01-preview",
      "name": "[parameters('dashboardName')]",
      "location": "[parameters('location')]",
      "tags": {
        "hidden-title": "[parameters('dashboardName')]"
      },
      "properties": {
        "lenses": [
          {
            "order": 0,
            "parts": [
              {
                "position": {
                  "x": 0,
                  "y": 0,
                  "colSpan": 6,
                  "rowSpan": 4
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": "[variables('applicationInsightsId')]"
                    },
                    {
                      "name": "MetricsExplorerJsonDefinitionId",
                      "value": "pinJson:?name={\n  \"version\": \"1.4.1\",\n  \"isCustom\": true,\n  \"charts\": [\n    {\n      \"metrics\": [\n        {\n          \"resourceMetadata\": {\n            \"id\": \"[variables('applicationInsightsId')]\"\n          },\n          \"name\": \"requests/count\",\n          \"aggregationType\": 7,\n          \"namespace\": \"microsoft.insights/components\",\n          \"metricVisualization\": {\n            \"displayName\": \"Server requests\"\n          }\n        }\n      ],\n      \"title\": \"Request Rate\",\n      \"visualization\": {\n        \"chartType\": 2,\n        \"legendVisualization\": {\n          \"isVisible\": true,\n          \"position\": 2,\n          \"hideSubtitle\": false\n        },\n        \"axisVisualization\": {\n          \"x\": {\n            \"isVisible\": true,\n            \"axisType\": 2\n          },\n          \"y\": {\n            \"isVisible\": true,\n            \"axisType\": 1\n          }\n        }\n      }\n    }\n  ]\n}"
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "requests\n| where timestamp > ago(1h)\n| summarize RequestCount = count() by bin(timestamp, 5m)\n| render timechart\n",
                      "ControlType": "FrameControlChart",
                      "SpecificChart": "Line"
                    }
                  }
                }
              },
              {
                "position": {
                  "x": 6,
                  "y": 0,
                  "colSpan": 6,
                  "rowSpan": 4
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": "[variables('applicationInsightsId')]"
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "requests\n| where timestamp > ago(1h)\n| summarize AvgDuration = avg(duration), P95Duration = percentile(duration, 95), P99Duration = percentile(duration, 99) by bin(timestamp, 5m)\n| render timechart\n",
                      "ControlType": "FrameControlChart",
                      "SpecificChart": "Line"
                    }
                  }
                }
              },
              {
                "position": {
                  "x": 0,
                  "y": 4,
                  "colSpan": 6,
                  "rowSpan": 4
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": "[variables('applicationInsightsId')]"
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "requests\n| where timestamp > ago(1h)\n| summarize FailedRequests = countif(success == false), TotalRequests = count() by bin(timestamp, 5m)\n| extend ErrorRate = (FailedRequests * 100.0) / TotalRequests\n| render timechart\n",
                      "ControlType": "FrameControlChart",
                      "SpecificChart": "Line"
                    }
                  }
                }
              },
              {
                "position": {
                  "x": 6,
                  "y": 4,
                  "colSpan": 6,
                  "rowSpan": 4
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": "[variables('applicationInsightsId')]"
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "exceptions\n| where timestamp > ago(1h)\n| summarize ExceptionCount = count() by type, bin(timestamp, 5m)\n| render timechart\n",
                      "ControlType": "FrameControlChart",
                      "SpecificChart": "StackedColumn"
                    }
                  }
                }
              },
              {
                "position": {
                  "x": 0,
                  "y": 8,
                  "colSpan": 4,
                  "rowSpan": 4
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": "[variables('applicationInsightsId')]"
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "requests\n| where timestamp > ago(24h)\n| summarize RequestCount = count() by url\n| top 10 by RequestCount desc\n| render barchart\n",
                      "ControlType": "FrameControlChart",
                      "SpecificChart": "Bar"
                    }
                  }
                }
              },
              {
                "position": {
                  "x": 4,
                  "y": 8,
                  "colSpan": 4,
                  "rowSpan": 4
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": "[variables('applicationInsightsId')]"
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "dependencies\n| where timestamp > ago(1h)\n| where type == 'SQL'\n| summarize AvgDuration = avg(duration), CallCount = count() by name\n| top 10 by AvgDuration desc\n| render barchart\n",
                      "ControlType": "FrameControlChart",
                      "SpecificChart": "Bar"
                    }
                  }
                }
              },
              {
                "position": {
                  "x": 8,
                  "y": 8,
                  "colSpan": 4,
                  "rowSpan": 4
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": "[variables('applicationInsightsId')]"
                    }
                  ],
                  "type": "Extension/Microsoft_OperationsManagementSuite_Workspace/PartType/LogsDashboardPart",
                  "settings": {
                    "content": {
                      "Query": "customMetrics\n| where timestamp > ago(1h)\n| where name startswith 'Container'\n| summarize avg(value) by name, bin(timestamp, 5m)\n| render timechart\n",
                      "ControlType": "FrameControlChart",
                      "SpecificChart": "Line"
                    }
                  }
                }
              }
            ]
          }
        ],
        "metadata": {
          "model": {
            "timeRange": {
              "value": {
                "relative": {
                  "duration": 24,
                  "timeUnit": 1
                }
              },
              "type": "MsPortalFx.Composition.Configuration.ValueTypes.TimeRange"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "dashboardId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Portal/dashboards', parameters('dashboardName'))]"
    }
  }
}
